{% extends "core/base.html" %}

{% block content %}
<style>
.tracking-container {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin: 30px 0;
}

.tracking-container::before {
    content: "";
    position: absolute;
    top: 20px;
    left: 0;
    width: 100%;
    height: 4px;
    background: #d3d3d3;
    z-index: 1;
}

.track-step {
    text-align: center;
    width: 20%;
    position: relative;
    z-index: 2;
}

.track-step .dot {
    width: 22px;
    height: 22px;
    background: #d3d3d3;
    border-radius: 50%;
    margin: 0 auto;
    border: 3px solid #d3d3d3;
    transition: 0.3s;
}

.track-step.active .dot {
    background: #28a745 !important;
    border-color: #28a745 !important;
}

.track-step p {
    margin-top: 8px;
    font-weight: 600;
    color: #777;
}

.track-step.active p {
    color: #28a745 !important;
}
</style>

<!-- ORDER TRACKING -->
<div class="tracking-container">
    <div class="track-step {% if order.status != 'cancelled' %}active{% endif %}">
        <span class="dot"></span>
        <p>Pending</p>
    </div>

    <div class="track-step {% if order.status in 'processing shipped out_for_delivery delivered' %}active{% endif %}">
        <span class="dot"></span>
        <p>Processing</p>
    </div>

    <div class="track-step {% if order.status in 'shipped out_for_delivery delivered' %}active{% endif %}">
        <span class="dot"></span>
        <p>Shipped</p>
    </div>

    <div class="track-step {% if order.status in 'out_for_delivery delivered' %}active{% endif %}">
        <span class="dot"></span>
        <p>Out For Delivery</p>
    </div>

    <div class="track-step {% if order.status == 'delivered' %}active{% endif %}">
        <span class="dot"></span>
        <p>Delivered</p>
    </div>
</div>


<div class="container my-4">

    <h3 class="mb-4 text-center">Order Details</h3>

    <!-- Order Info -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">Order Information</div>
        <div class="card-body">
            <p><strong>Order ID:</strong> #{{ order.id }}</p>
            <p><strong>Date:</strong> {{ order.created_at|date:"d M Y, H:i A" }}</p>
            <p><strong>Payment:</strong> {{ order.payment_method }}</p>
            <p><strong>Total:</strong> ₹{{ order.total_amount }}</p>
            <p><strong>Delivery:</strong> {{ order.estimated_delivery|date:"d M Y" }}</p>
        </div>
    </div>

    <!-- Address -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">Delivery Address</div>
        <div class="card-body">
            <p>{{ order.full_name }}</p>
            <p>{{ order.phone }}</p>
            <p>{{ order.address }}, {{ order.city }} - {{ order.pincode }}</p>
        </div>
    </div>

    <!-- Items -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">Ordered Items</div>
        <div class="card-body">
            <ul class="list-group">
                {% for item in items %}
                <li class="list-group-item d-flex justify-content-between">
                    <div>
                        <strong>{{ item.product.name }}</strong><br>
                        <small>{{ item.quantity }} × ₹{{ item.price }}</small>
                    </div>

                    <div class="text-end">
                        <span class="fw-bold">₹{{ item.get_subtotal }}</span><br>

                        {% comment %} Check if return exists / refunded {% endcomment %}
{% with existing=item.returnrequest_set.first %}
    {% if order.status == "delivered" %}
        {% if existing %}
            {% if existing.status == "pending" %}
                <span class="badge bg-warning">Return Requested</span>
            {% elif existing.status == "approved" %}
                <span class="badge bg-info">Approved</span>
            {% elif existing.status == "refunded" %}
                <span class="badge bg-success">Refunded</span>
            {% elif existing.status == "rejected" %}
                <span class="badge bg-danger">Rejected</span>
            {% endif %}
        {% else %}
            <a href="{% url 'request_return' item.id %}" class="btn btn-warning btn-sm">
                Request Return
            </a>
        {% endif %}
    {% endif %}
{% endwith %}

                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

</div>

{% endblock %}
